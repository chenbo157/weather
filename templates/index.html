<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Weather Query</title>
</head>
<body>
  <h2>Weather Query</h2>

  <form id="queryForm">
    <label>Latitude:
      <input type="number" step="0.01" name="lat" required value="30.5">
    </label><br>

    <label>Longitude:
      <input type="number" step="0.01" name="lon" required value="120.5">
    </label><br>

    <label>Start Time (UTC):
      <input type="datetime-local" name="time" required id="timeInput">
    </label><br>

    <label>Hours:
      <input type="number" name="hours" value="24">
    </label><br>

    <label>Variables:<br>
      <input type="checkbox" name="vars" value="t2m" checked> Temperature (t2m)<br>
      <input type="checkbox" name="vars" value="v100" checked> Wind Speed (v100)<br>
      <!-- 可继续添加变量 -->
    </label><br>


    <label>Resolution (hours):
      <input type="number" name="resolution" value="1" min="1">
    </label><br>

    <button type="submit">Submit</button>
  </form>

  <hr>
  <div id="result"></div>

  <script>
    // 设置默认时间为2025-06-01 00:00 (UTC)
    document.getElementById("timeInput").value = "2025-06-01T00:00";

    const form = document.getElementById("queryForm");
    const resultDiv = document.getElementById("result");

    function renderTables(data) {
      resultDiv.innerHTML = ""; // 清空内容

      for (const [varName, varData] of Object.entries(data.data)) {
        // 标题
        const title = document.createElement("h3");
        title.textContent = `${varName} (单位: ${varData.unit})`;
        resultDiv.appendChild(title);

        // 表格
        const table = document.createElement("table");
        table.border = "1";
        table.style.borderCollapse = "collapse";
        table.style.marginBottom = "20px";

        // 表头
        const thead = document.createElement("thead");
        const headerRow = document.createElement("tr");
        ["时间", "数值"].forEach(text => {
          const th = document.createElement("th");
          th.textContent = text;
          th.style.padding = "4px 8px";
          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);

        // 表体
        const tbody = document.createElement("tbody");
        varData.values.forEach(({time, value}) => {
          const tr = document.createElement("tr");

          const tdTime = document.createElement("td");
          tdTime.textContent = time;
          tdTime.style.padding = "2px 6px";

          const tdValue = document.createElement("td");
          tdValue.textContent = value.toFixed(3);
          tdValue.style.padding = "2px 6px";

          tr.appendChild(tdTime);
          tr.appendChild(tdValue);
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);

        resultDiv.appendChild(table);
      }
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const formData = new FormData(form);
      const lat = parseFloat(formData.get("lat"));
      const lon = parseFloat(formData.get("lon"));
      const time = formData.get("time");
      const hours = parseInt(formData.get("hours"));
      const vars = formData.getAll("vars");
      const resolution = parseInt(formData.get("resolution")) || 1;

      const body = { lat, lon, time, vars, hours, resolution };

      try {
        const res = await fetch("/weather", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.detail || "Request failed");
        }

        const data = await res.json();

        // 渲染成表格
        renderTables(data);

      } catch (err) {
        resultDiv.textContent = "Error: " + err.message;
      }
    });
  </script>
</body>
</html>
